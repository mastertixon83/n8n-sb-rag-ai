# Проект N8N + Supabase + RAG AI
![banner](https://github.com/user-attachments/assets/f8c84551-6f8e-4363-add2-c7ccebbe4f61)



Этот репозиторий содержит мощный набор скриптов для автоматизированной установки и управления локальными стеками n8n и Supabase, интегрированных для работы с AI-сервисами (например, RAG - Retrieval-Augmented Generation). Проект призван упростить развертывание сложной инфраструктуры для разработки и тестирования автоматизаций и приложений.

## Описание проекта

Данный проект предоставляет инсталлятор и управляющий скрипт для быстрой развертки локального окружения, включающего:

* **n8n:** Гибкая и расширяемая платформа для автоматизации рабочих процессов, позволяющая легко соединять различные API и сервисы.
* **Supabase:** Открытая альтернатива Firebase, предоставляющая PostgreSQL базу данных, аутентификацию, хранилище файлов, функции Edge Functions и многое другое. Идеально подходит для бэкенда современных приложений.
* **Cloudflare Tunnel:** Безопасное подключение вашего локального n8n к публичному интернету без открытия портов на вашем сервере, что обеспечивает безопасный доступ к вебхукам и UI.
* **PGAdmin:** Популярный и мощный веб-интерфейс для администрирования PostgreSQL баз данных.
* **Inbucket:** Простой локальный SMTP-сервер, который позволяет перехватывать и просматривать исходящие электронные письма в dev-среде, не отправляя их реальным получателям.

### Основные возможности инсталлятора:

* **Автоматическая генерация конфигураций:** Создание `docker-compose.yml` и `.env` файлов из Jinja2 шаблонов.
* **Управление секретами:** Генерация надежных случайных паролей и секретных ключей для всех сервисов.
* **Интерактивная установка:** Скрипт запрашивает необходимые данные у пользователя, обеспечивая простоту настройки.
* **Управление жизненным циклом:** Команды для установки, перезапуска (с сохранением или удалением данных) и полного удаления стеков.
* **Общая Docker сеть:** Все сервисы разворачиваются в одной общей сети для бесшовной коммуникации.

## Требования

Для успешного запуска проекта на вашей машине должны быть установлены:

* **Docker** (рекомендуется последняя стабильная версия)
* **Docker Compose** (рекомендуется `docker compose` CLI, часть Docker Desktop)
* **Python 3.10.5+**
* **`pip`** для управления зависимостями Python.
* **Git** для клонирования репозиториев.

## Предварительная настройка Cloudflare и Домена

**Перед началом установки инсталлятора, выполните следующие обязательные шаги:**

1.  **Купите доменное имя.**
2.  **Зарегистрируйтесь в Cloudflare** и добавьте ваш домен в свой аккаунт Cloudflare.
3.  **Привяжите ваш домен к Cloudflare**, следуя инструкциям Cloudflare по обновлению NS-записей у вашего регистратора домена.
4.  **Настройте Cloudflare Tunnel:**
    * В панели управления Cloudflare создайте новый Tunnel.
    * Следуйте инструкциям Cloudflare для установки `cloudflared` на вашем сервере (или используйте Docker-контейнер `cloudflare/cloudflared`).
    * Получите **токен туннеля** (Cloudflare Tunnel Token), который понадобится вам в процессе установки инсталлятора.
    * Настройте публичный хост (Public Hostname) в вашем туннеле, который будет указывать на ваш n8n-сервис. Например, если ваш n8n будет доступен по адресу `https://n8n.yourdomain.com`, настройте его в Cloudflare Tunnel, указав внутренний адрес вашего n8n-сервиса (например, `http://n8n_app:443` или `http://localhost:443` в Docker-контейнере `cloudflared`). **Важно: для корректной работы webhooks telegram через Cloudflare Tunnel, убедитесь, что в настройках туннеля для `n8n_app` указан порт 443.**

## Установка зависимостей и подготовка

Теперь, когда Cloudflare и домен настроены, вы можете приступить к подготовке инсталлятора:

1.  **Клонируйте репозиторий инсталлятора:**

        git clone [https://github.com/ВАШ_ПОЛЬЗОВАТЕЛЬ/ВАШ_РЕПОЗИТОРИЙ.git](https://github.com/ВАШ_ПОЛЬЗОВАТЕЛЬ/ВАШ_РЕПОЗИТОРИЙ.git)
        cd ВАШ_РЕПОЗИТОРИЙ


2.  **Создайте и активируйте виртуальное окружение (рекомендуется):**

        python -m venv venv
        source venv/bin/activate # Для Linux/macOS
        # venv\Scripts\activate # Для Windows CMD/PowerShell


3.  **Установите зависимости Python:**

        pip install -r req.txt


4.  **Клонируйте репозиторий Supabase CLI:**
    **Это критически важный шаг перед запуском инсталлятора.** Ваш инсталлятор ожидает, что этот репозиторий будет доступен в корневой директории инсталлятора.

        git clone https://github.com/supabase/supabase.git
 

## Структура проекта

.
├── main.py                     # Основной исполняемый скрипт CLI

├── config.py                   # Определение класса AppConfig для хранения и сбора всех настроек

├── setup_n8n.py                # Скрипт для настройки и запуска стека n8n

├── setup_supabase.py           # Скрипт для настройки и запуска стека Supabase

├── utils.py                    # Вспомогательные функции (генерация случайных строк, выполнение команд)

├── req.txt                     # Список зависимостей Python

├── supabase/                   # &lt;-- Сюда будет склонирован репозиторий Supabase CLI

├── templates/                  # Директория с Jinja2 шаблонами для конфигурационных файлов

│   ├── n8n_docker_compose_template.j2  # Шаблон docker-compose.yml для n8n стека

│   ├── n8n_env_template.j2             # Шаблон .env для n8n стека

│   ├── supabase_docker_compose.j2      # Шаблон docker-compose.yml для Supabase стека

│   ├── supabase_env.j2                 # Шаблон .env для Supabase стека

│   ├── supabase_kong.j2                # Шаблон конфигурации Kong для Supabase

│   ├── supabase_vector.j2              # Шаблон конфигурации vector-агента для Supabase

│   └── supabase_jwt_sql.j2             # Шаблон SQL скрипта для настройки JWT в Supabase

└── (после запуска инсталлятора)

├── .env                        # Сгенерированный файл с переменными окружения для Docker Compose

├── docker-compose.yml          # Сгенерированный docker-compose.yml для n8n и общих сервисов

├── n8n_data/                   # Том для данных n8n (workflows, credentials, etc.)

├── n8n_postgres_data/          # Том для данных PostgreSQL для n8n

├── n8n_init                    # SQL-скрипты для инициализации и настройки БД для n8n

├── n8n_pgadmin_data/           # Том для данных PGAdmin

├── supabase-project/           # Директория для файлов конфигурации и томов Supabase

│   ├── docker-compose.yml      # Сгенерированный docker-compose.yml для Supabase

│   ├── supabase_db_data/       # Том для данных PostgreSQL для Supabase

│   └── volumes/                # Директория с файлами и томами, используемыми Supabase

│       ├── api/

│       │   └── kong.yml        # Конфигурация Kong

│       ├── db/                 # SQL-скрипты для инициализации и настройки БД

│       │   ├── init/

│       │   │   └── data.sql

│       │   ├── jwt.sql

│       │   ├── logs.sql

│       │   ├── pooler.sql

│       │   ├── realtime.sql

│       │   ├── roles.sql

│       │   ├── _supabase.sql

│       │   └── webhooks.sql

│       ├── functions/          # Edge Functions

│       │   ├── hello/

│       │   │   └── index.ts

│       │   └── main/

│       │       └── index.ts

│       ├── logs/

│       │   └── vector.yml      # Конфигурация vector-агента

│       ├── pooler/

│       │   └── pooler.exs

│       └── storage/

│           └── stub

└── summary.txt                 # Файл с краткой сводкой доступа и сгенерированными секретами

## Установка и запуск стеков

Для установки и начального запуска всех сервисов используйте команду `install`. Скрипт будет интерактивно запрашивать необходимые данные (URL для n8n, API-ключи и т.д.).


        python main.py install

Важные параметры во время установки (интерактивные запросы):
Webhook URL для n8n: Введите полный публичный URL, который будет использоваться для доступа к вашему n8n UI и вебхукам (например, https://n8n.yourdomain.com). Этот URL должен соответствовать публичному хосту, настроенному в вашем Cloudflare Tunnel!
Cloudflare Tunnel Token: Введите токен вашего Cloudflare Tunnel, который вы получили на этапе предварительной настройки.
OpenAI API Key (для n8n и Supabase): Ваш ключ API для интеграции с OpenAI.
Пароли для баз данных и админ-панелей: Скрипт может генерировать их автоматически или запросить ввод.
Доступ к сервисам
После успешной установки и запуска, все необходимые данные для доступа к сервисам (URL, логины, сгенерированные пароли и ключи) будут записаны в файл summary.txt в корне проекта.

Пример содержимого summary.txt:

    🎉 Все компоненты (n8n, Supabase) успешно установлены и запущены!
    
            ➡ Доступ к N8N: [https://n8n.n8npblocally.xyz](https://n8n.n8npblocally.xyz)
            
            ➡ Доступ к PGAdmin: [http://0.0.0.0:5051/login?next=/](http://0.0.0.0:5051/login?next=/)
               Login: admin@example.com
               Pass:  gckWeG4PFeDzquPD
    
            ➡ Доступ к Postgres N8N:
               HOST: n8n_postgres  (Доступен только из Docker сети)
               DB:   n8n_pg_db
               User: n8n_pg_user
               Pass: GGo36K2nh5SyfpDVkVuoi38adzWvwBQ7
    
            ➡ Inbucket (почта): http://localhost:9000
    
            ➡ Supabase Studio: http://localhost:8000
               Login: supabase-admin
               Pass:  EcZMbYn7W7Wnsny6
    
            🗝 Supabase SERVICE_ROLE_KEY: <your_supabase_service_role_key>
      
(Обратите внимание: реальные значения будут подставлены после запуска инсталлятора. Хосты, такие как n8n_postgres, доступны только изнутри Docker-сети.)

Управление стеками (restart, destroy)
Перезапуск сервисов
Команда restart позволяет перезапускать отдельные стеки или оба сразу.

    # Перезапустить только n8n (сохраняя данные)
            python main.py restart --stack n8n
    
    # Перезапустить только Supabase (сохраняя данные)
        python main.py restart --stack supabase
    
    # Перезапустить все сервисы (n8n + Supabase), сохраняя данные
        python main.py restart --stack all
Опция --recreate (удаление данных):
Используйте флаг --recreate для полного пересоздания стека с удалением всех его Docker томов. Это полезно при возникновении проблем с базой данных (например, password authentication failed) или при необходимости начать с чистого листа.

    # Пересоздать n8n с удалением всех данных (потребуется подтверждение)
        python main.py restart --stack n8n --recreate
    
    # Полностью пересоздать все сервисы с нуля (удалить все данные, потребуется подтверждение)
        python main.py restart --stack all --recreate
Будьте осторожны! Использование --recreate приведет к потере всех ваших данных (рабочих процессов n8n, данных Supabase и т.д.) для выбранного стека.

Удаление всех сервисов
Команда destroy полностью останавливает и удаляет все запущенные контейнеры, тома и конфигурационные файлы, связанные с n8n и Supabase, которые были созданы инсталлятором.

    # Удалить все сервисы (потребуется подтверждение)
    python main.py destroy

    # Удалить все сервисы без запроса подтверждения
    python main.py destroy --confirm
Важное примечание: Команда destroy удаляет только Docker-контейнеры, сети и автоматически созданные Docker-тома. Некоторые директории с данными могут остаться на вашей файловой системе для предотвращения случайной потери данных. После выполнения destroy, для полной очистки, вам может потребоваться вручную удалить следующие директории:

    sudo rm -rf n8n_data/ n8n_postgres_data/ n8n_pgadmin_data/ supabase-project/
Эта команда должна быть выполнена из корневой директории вашего инсталлятора.
